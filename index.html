<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradient Maker: CSS Gradient Editor & Generator</title>
    <meta name="description" content="An advanced, responsive CSS gradient editor to create stunning linear, radial, and conic gradients with real-time preview, code output, and sharing.">
    <meta name="keywords" content="CSS gradient editor, linear gradient, radial gradient, conic gradient, gradient generator, CSS tool, color stops, Tailwind CSS">
    <link rel="canonical" href="https://example.com/gradient-studio">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
        }
        input[type="range"]::-moz-range-track {
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background 0.2s;
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            background: #3730a3;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background 0.2s;
        }
        input[type="range"]:hover::-moz-range-thumb {
            background: #3730a3;
        }

        /* Styles for the temporary utility message box */
        .message-box {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
        }
        
        /* Styles for the donation popup */
        .donation-popup {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            color: #1e293b;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            max-width: 90%;
            min-width: 300px;
        }

        .donation-popup.show {
            opacity: 1;
            bottom: 1.5rem;
            pointer-events: auto;
        }

        .active-type {
            background-color: #4f46e5 !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2), 0 2px 4px -2px rgba(79, 70, 229, 0.1) !important;
            border: 2px solid #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-slate-800 selection:bg-indigo-200">
    <nav class="bg-white p-4 shadow-lg sticky top-0 z-50 border-b border-slate-200" aria-label="Main navigation">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center max-w-5xl">
            <h1 class="text-xl font-extrabold text-indigo-700 tracking-tighter mb-2 sm:mb-0">Gradient Maker</h1>
            <div class="flex space-x-3 sm:space-x-6 text-sm">
                <a href="#" class="text-slate-600 font-medium px-3 py-1 rounded-lg transition-colors duration-200 hover:bg-slate-100 hover:text-indigo-600">Creator</a>
                <a href="gallery.html" class="text-slate-600 font-medium px-3 py-1 rounded-lg transition-colors duration-200 hover:bg-slate-100 hover:text-indigo-600">Gallery</a>
                <a href="Palettes.html" class="text-slate-600 font-medium px-3 py-1 rounded-lg transition-colors duration-200 hover:bg-slate-100 hover:text-indigo-600">Palettes</a>
            </div>
        </div>
    </nav>
    
    <main class="w-full max-w-5xl mx-auto space-y-12 p-6 sm:p-10">
        <header class="text-center pt-4 pb-2">
            <h2 class="text-3xl sm:text-4xl font-bold text-slate-900">CSS Gradient Generator</h2>
            <p class="text-slate-500 mt-2">Design, preview, and copy your perfect CSS gradients with ease.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <section class="space-y-6 order-2 lg:order-1">
                <div id="gradientPreview" class="w-full h-64 sm:h-80 lg:h-[400px] rounded-2xl shadow-2xl transition-all duration-500 ease-in-out border-4 border-white transform hover:scale-[1.01]" role="img" aria-label="Live gradient preview"></div>

                <div class="relative mt-8 bg-white p-5 rounded-xl shadow-md border border-slate-200">
                    <label for="cssOutput" class="block text-sm font-semibold text-slate-700 mb-3">Generated CSS Code</label>
                    <textarea id="cssOutput" readonly class="w-full h-28 p-3 bg-slate-50 rounded-lg font-mono text-sm border border-slate-300 focus:outline-none focus:border-indigo-500 transition-colors duration-200 resize-none"></textarea>
                    
                    <div class="absolute top-10 right-8 flex space-x-3">
                        <button id="shareBtn" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg transition-all duration-200 hover:bg-indigo-600 active:scale-90" title="Copy Share URL" aria-label="Copy share URL to clipboard">
                            <i class="fas fa-link w-5 h-5 flex items-center justify-center" aria-hidden="true"></i>
                        </button>
                        <button id="copyBtn" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg transition-all duration-200 hover:bg-indigo-600 active:scale-90" title="Copy CSS Code" aria-label="Copy CSS code to clipboard">
                            <i id="copyIcon" class="far fa-copy w-5 h-5 flex items-center justify-center" aria-hidden="true"></i>
                            <i id="checkIcon" class="fas fa-check w-5 h-5 text-green-300 hidden flex items-center justify-center" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </section>

            <section class="space-y-8 order-1 lg:order-2 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                
                <div role="radiogroup" aria-labelledby="gradient-type-label">
                    <h3 id="gradient-type-label" class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700">
                        <i class="fas fa-palette text-indigo-500"></i> Gradient Type
                    </h3>
                    <div class="flex space-x-3 p-1 bg-slate-100 rounded-xl">
                        <button id="linearBtn" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-98 active-type" role="radio" aria-checked="true">Linear</button>
                        <button id="radialBtn" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-98" role="radio" aria-checked="false">Radial</button>
                        <button id="conicBtn" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-98" role="radio" aria-checked="false">Conic</button>
                    </div>
                </div>
                
                <div id="angleControl" class="space-y-4 pt-2">
                    <h3 class="text-xl font-bold flex items-center gap-2 text-slate-700" id="angle-label">
                        <i class="fas fa-compass text-indigo-500"></i> Angle: <span id="angleValue" class="text-indigo-600 ml-2 font-extrabold text-2xl">90Â°</span>
                    </h3>
                    <input id="angleSlider" type="range" min="0" max="360" value="90" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" aria-valuetext="90 degrees" aria-labelledby="angle-label">
                </div>
                
                <div class="space-y-4 pt-2">
                    <h3 class="text-xl font-bold flex items-center gap-2 text-slate-700" id="opacity-label">
                        <i class="fas fa-fill-drip text-indigo-500"></i> Opacity: <span id="opacityValue" class="text-indigo-600 ml-2 font-extrabold text-2xl">100%</span>
                    </h3>
                    <input id="opacitySlider" type="range" min="0" max="100" value="100" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" aria-valuetext="100 percent" aria-labelledby="opacity-label">
                </div>
                
                <fieldset class="border-t border-slate-200 pt-6">
                    <legend class="flex items-center justify-between mb-4 text-xl font-bold w-full text-slate-700">
                        <span class="flex items-center gap-2"><i class="fas fa-fill text-indigo-500"></i> Color Stops</span>
                        <div class="flex gap-3">
                            <button id="randomizeBtn" class="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition-colors duration-200 active:scale-95 group" title="Randomize colors" aria-label="Randomize colors and stops">
                                <i class="fas fa-random w-5 h-5 flex items-center justify-center group-hover:rotate-12 transition-transform" aria-hidden="true"></i>
                            </button>
                            <button id="addColorBtn" class="p-2 bg-green-500 text-white rounded-full shadow-md hover:bg-green-600 transition-colors duration-200 active:scale-95" title="Add a color stop" aria-label="Add a new color stop">
                                <i class="fas fa-plus w-5 h-5 flex items-center justify-center" aria-hidden="true"></i>
                            </button>
                        </div>
                    </legend>
                    <div id="colorStopsContainer" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                        </div>
                </fieldset>
            </section>
        </div>
    </main>
    
    <div id="messageBox" class="message-box p-4 flex items-center gap-4" role="status" aria-live="polite" aria-hidden="true">
        <i class="fas fa-info-circle text-indigo-400" aria-hidden="true"></i>
        <span class="font-medium"></span>
        <button id="closeMessageBtn" class="text-slate-400 p-1 rounded-full hover:bg-slate-700 transition-colors duration-200 ml-auto" aria-label="Close notification">
            <i class="fas fa-times w-4 h-4 flex items-center justify-center" aria-hidden="true"></i>
        </button>
    </div>

    <div id="donationPopup" class="donation-popup" role="dialog" aria-modal="false" aria-labelledby="donation-heading">
        <div class="flex items-start justify-between w-full">
            <h4 id="donation-heading" class="text-lg font-extrabold text-indigo-600 flex items-center">
                <i class="fas fa-heart text-red-500 mr-2"></i> Support via Crypto
            </h4>
            <button id="closeDonationBtn" class="text-slate-400 hover:text-slate-600 p-1 rounded-full transition-colors duration-200" aria-label="Close donation request">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p class="text-sm text-slate-600 mt-2 mb-4 text-center">
            Enjoy using this Ad-free tool? Please consider donating bitcoin using the qr code below..
        </p>
        <div class="flex justify-center">
            <img src="images/qr_code.png" alt="QR Code for Crypto Donation" class="w-36 h-36 border-4 border-slate-100 rounded-lg shadow-inner p-1">
        </div>
    </div>
    <script>
        // DOM Elements
        const gradientPreview = document.getElementById('gradientPreview');
        const cssOutput = document.getElementById('cssOutput');
        const copyBtn = document.getElementById('copyBtn');
        const shareBtn = document.getElementById('shareBtn');
        const linearBtn = document.getElementById('linearBtn');
        const radialBtn = document.getElementById('radialBtn');
        const conicBtn = document.getElementById('conicBtn');
        const angleControl = document.getElementById('angleControl');
        const angleSlider = document.getElementById('angleSlider');
        const angleValue = document.getElementById('angleValue');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const addColorBtn = document.getElementById('addColorBtn');
        const randomizeBtn = document.getElementById('randomizeBtn');
        const colorStopsContainer = document.getElementById('colorStopsContainer');
        const messageBox = document.getElementById('messageBox');
        const copyIcon = document.getElementById('copyIcon');
        const checkIcon = document.getElementById('checkIcon');
        const closeMessageBtn = document.getElementById('closeMessageBtn');

        // NEW DONATION ELEMENTS
        const donationPopup = document.getElementById('donationPopup');
        const closeDonationBtn = document.getElementById('closeDonationBtn');
        // Removed maybeLaterDonationBtn reference

        // State Variables
        let gradientType = 'linear-gradient';
        let colors = [];
        let nextColorId = 1;
        let angle = 90;
        let opacity = 100;
        
        // Donation State
        const DONATION_STORAGE_KEY = 'donation_prompted';


        // --- Utility Functions ---

        /** Converts hex color to RGBA string with a given alpha (0.0 to 1.0). */
        const hexToRgbA = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha.toFixed(2)})`; // fixed decimal precision
        };

        /** Generates a random hex color. */
        const getRandomHexColor = () => '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');


        // --- Gradient Logic ---

        /** Updates the gradient preview and CSS output based on current state. */
        const updateGradient = () => {
            // Sort colors by position for correct CSS order
            colors.sort((a, b) => a.position - b.position);
            
            const alpha = opacity / 100;

            const colorString = colors.map(c => {
                return `${hexToRgbA(c.color, alpha)} ${c.position}%`;
            }).join(', ');

            let cssValue = '';
            switch (gradientType) {
                case 'linear-gradient':
                    cssValue = `${gradientType}(${angle}deg, ${colorString})`;
                    break;
                case 'radial-gradient':
                    // Using 'ellipse at center' for a more common default radial
                    cssValue = `${gradientType}(ellipse at center, ${colorString})`; 
                    break;
                case 'conic-gradient':
                    cssValue = `${gradientType}(from ${angle}deg, ${colorString})`;
                    break;
            }

            gradientPreview.style.backgroundImage = cssValue;
            // Add vendor prefixes for wider compatibility (a nice generator feature)
            cssOutput.value = `-webkit-box-shadow: none;\n-webkit-background-image: ${cssValue};\nbackground-image: ${cssValue};`; 
        };

        /** Creates the interactive HTML element for a single color stop. */
        const createColorStopElement = (colorObject) => {
            const container = document.createElement('div');
            // Added shadow-sm and border for a lifted, clearer look
            container.classList.add('flex', 'items-center', 'space-x-4', 'bg-slate-50', 'p-3', 'rounded-lg', 'shadow-sm', 'border', 'border-slate-200'); 
            container.dataset.id = colorObject.id;

            // Color Input (Picker)
            const colorInput = document.createElement('input');
            colorInput.type = 'color';
            colorInput.value = colorObject.color;
            colorInput.id = `color-input-${colorObject.id}`;
            // Refined picker style
            colorInput.classList.add('w-10', 'h-10', 'min-w-10', 'rounded-full', 'border-4', 'border-white', 'cursor-pointer', 'shadow-md'); 
            colorInput.setAttribute('aria-label', `Color picker for stop ${colorObject.id}`);
            colorInput.addEventListener('input', (e) => {
                const updatedColor = colors.find(c => c.id === colorObject.id);
                if (updatedColor) {
                    updatedColor.color = e.target.value;
                    updateGradient();
                }
            });

            // Position Slider and Label
            const positionWrapper = document.createElement('div');
            positionWrapper.classList.add('flex-1', 'space-y-1');
            const positionLabel = document.createElement('label');
            positionLabel.htmlFor = `position-input-${colorObject.id}`;
            positionLabel.classList.add('block', 'text-sm', 'font-semibold', 'text-slate-700');
            positionLabel.textContent = `Position: ${colorObject.position}%`;
            positionLabel.id = `position-label-${colorObject.id}`;
            const positionInput = document.createElement('input');
            positionInput.type = 'range';
            positionInput.min = '0';
            positionInput.max = '100';
            positionInput.value = colorObject.position;
            positionInput.id = `position-input-${colorObject.id}`;
            positionInput.classList.add('w-full', 'h-2', 'bg-slate-200', 'rounded-lg', 'appearance-none', 'cursor-pointer');
            positionInput.setAttribute('aria-valuetext', `${colorObject.position} percent`);
            positionInput.setAttribute('aria-labelledby', `position-label-${colorObject.id}`);
            positionInput.addEventListener('input', (e) => {
                const updatedColor = colors.find(c => c.id === colorObject.id);
                if (updatedColor) {
                    updatedColor.position = parseInt(e.target.value);
                    positionLabel.textContent = `Position: ${e.target.value}%`;
                    positionInput.setAttribute('aria-valuetext', `${e.target.value} percent`);
                    updateGradient();
                }
            });
            positionWrapper.appendChild(positionLabel);
            positionWrapper.appendChild(positionInput);

            // Remove Button
            const removeBtn = document.createElement('button');
            // Improved button style
            removeBtn.classList.add('p-2', 'bg-slate-200', 'text-slate-500', 'rounded-lg', 'hover:bg-red-500', 'hover:text-white', 'transition-all', 'duration-200', 'active:scale-95'); 
            removeBtn.title = 'Remove color stop';
            removeBtn.setAttribute('aria-label', `Remove color stop at position ${colorObject.position}%`);
            removeBtn.innerHTML = `<i class="fas fa-times w-4 h-4 flex items-center justify-center" aria-hidden="true"></i>`;
            removeBtn.addEventListener('click', () => {
                if (colors.length > 2) {
                    colors = colors.filter(c => c.id !== colorObject.id);
                    container.remove();
                    updateGradient();
                    showMessage('Color stop removed.', 1500);
                } else {
                    showMessage('Must have at least two color stops.', 3000);
                }
            });

            container.appendChild(colorInput);
            container.appendChild(positionWrapper);
            container.appendChild(removeBtn);
            return container;
        };

        /** Adds a new color stop to the gradient. */
        const addColorStop = () => {
            const newPosition = colors.length < 5 ? 50 : Math.floor(Math.random() * 101); // Default to 50 if few colors, otherwise random
            const newColor = { id: nextColorId++, color: getRandomHexColor(), position: newPosition };
            colors.push(newColor);
            colorStopsContainer.appendChild(createColorStopElement(newColor));
            updateGradient();
            showMessage('New color stop added.', 1500);
        };

        /** Generates a random set of colors and positions. */
        const generateRandomColors = () => {
            colors = [];
            colorStopsContainer.innerHTML = '';
            // Generate between 2 and 5 colors
            const numColors = Math.floor(Math.random() * 4) + 2; 
            for (let i = 0; i < numColors; i++) {
                const randomHex = getRandomHexColor();
                // Distribute stops more evenly for better visuals
                const randomPosition = Math.round((i / (numColors - 1)) * 100); 
                const newColor = { id: nextColorId++, color: randomHex, position: randomPosition };
                colors.push(newColor);
                colorStopsContainer.appendChild(createColorStopElement(newColor));
            }
            // Also randomize gradient type for full randomness
            const types = [linearBtn, radialBtn, conicBtn];
            const randomTypeButton = types[Math.floor(Math.random() * types.length)];
            randomTypeButton.click();
            
            updateGradient();
            showMessage('New random gradient generated! âœ¨', 3000);
        };


        // --- UI & State Management ---

        /** Displays a temporary notification message. */
        const showMessage = (msg, duration = 2000) => {
            // Close donation popup if utility message is shown
            hideDonationPopup(); 

            const span = messageBox.querySelector('span');
            span.textContent = msg;
            messageBox.style.cssText = 'opacity: 1; bottom: 1.5rem; pointer-events: auto;';
            messageBox.setAttribute('aria-hidden', 'false');
            clearTimeout(window.messageTimeout);
            window.messageTimeout = setTimeout(() => {
                messageBox.style.cssText = 'opacity: 0; bottom: -999px; pointer-events: none;';
                messageBox.setAttribute('aria-hidden', 'true');
            }, duration);
        };

        /** Sets the active gradient type button style and state. */
        const setActiveButton = (activeButton) => {
            const allButtons = [linearBtn, radialBtn, conicBtn];
            allButtons.forEach(btn => {
                btn.classList.remove('active-type');
                btn.setAttribute('aria-checked', 'false');
            });
            activeButton.classList.add('active-type');
            activeButton.setAttribute('aria-checked', 'true');
        };

        /** Generates a base64 encoded URL containing the gradient data. */
        const generateShareURL = () => {
            const gradientData = {
                type: gradientType,
                colors: colors.map(c => ({ color: c.color, position: c.position })),
                angle: angle,
                opacity: opacity
            };
            const jsonString = JSON.stringify(gradientData);
            const base64String = btoa(jsonString);
            // Use window.location.origin for robustness
            const shareUrl = `${window.location.origin}${window.location.pathname}?gradient=${base64String}`; 
            return shareUrl;
        };

        /** Loads gradient data from the URL query parameter if present. */
        const loadFromURL = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gradientParam = urlParams.get('gradient');
            if (gradientParam) {
                try {
                    const jsonString = atob(gradientParam);
                    const gradientData = JSON.parse(jsonString);

                    // 1. Type
                    if (gradientData.type) {
                        gradientType = gradientData.type;
                        if (gradientType === 'linear-gradient') setActiveButton(linearBtn);
                        else if (gradientType === 'radial-gradient') setActiveButton(radialBtn);
                        else if (gradientType === 'conic-gradient') setActiveButton(conicBtn);
                    }
                    angleControl.style.display = (gradientType === 'radial-gradient') ? 'none' : 'block';

                    // 2. Colors
                    if (gradientData.colors && Array.isArray(gradientData.colors) && gradientData.colors.length >= 2) {
                        colors = gradientData.colors.map((c, index) => ({
                            id: index + 1,
                            // Ensure color is a valid hex, default to black if not
                            color: /^#([0-9A-F]{3}){1,2}$/i.test(c.color) ? c.color : '#000000', 
                            position: Math.max(0, Math.min(100, c.position)) // Clamp position
                        }));
                        nextColorId = colors.length + 1;
                        colorStopsContainer.innerHTML = '';
                        colors.forEach(color => colorStopsContainer.appendChild(createColorStopElement(color)));
                    } else {
                        // If colors are invalid, treat as failed load
                        return false; 
                    }

                    // 3. Angle
                    if (gradientData.angle !== undefined) {
                        angle = Math.max(0, Math.min(360, gradientData.angle)); // Clamp angle
                        angleSlider.value = angle;
                        angleValue.textContent = `${angle}Â°`;
                        angleSlider.setAttribute('aria-valuetext', `${angle} degrees`);
                    }

                    // 4. Opacity
                    if (gradientData.opacity !== undefined) {
                        opacity = Math.max(0, Math.min(100, gradientData.opacity)); // Clamp opacity
                        opacitySlider.value = opacity;
                        opacityValue.textContent = `${opacity}%`;
                        opacitySlider.setAttribute('aria-valuetext', `${opacity} percent`);
                    }

                    updateGradient();
                    showMessage('Gradient loaded from URL! ðŸ”—', 3000);
                    return true;
                } catch (e) {
                    console.error("Failed to parse URL gradient data:", e);
                    showMessage('Invalid gradient URL data.', 3000);
                    // Clear the faulty parameter from the URL bar
                    history.replaceState({}, document.title, window.location.pathname); 
                    return false;
                }
            }
            return false;
        };
        
        // --- Donation Popup Logic ---

        /** Shows the donation popup if it hasn't been prompted this session. */
        const showDonationPopup = () => {
            // Check session storage to prevent repeated popups in the same session
            if (sessionStorage.getItem(DONATION_STORAGE_KEY) !== 'true') {
                // Check if a utility message is currently visible/scheduled
                if (messageBox.style.opacity === '0' || !messageBox.style.opacity) {
                    donationPopup.classList.add('show');
                    donationPopup.setAttribute('aria-modal', 'true');
                }
            }
        };

        /** Hides the donation popup and flags it as seen for this session. */
        const hideDonationPopup = () => {
            donationPopup.classList.remove('show');
            donationPopup.setAttribute('aria-modal', 'false');
            sessionStorage.setItem(DONATION_STORAGE_KEY, 'true'); // Flag as seen for this session
        };


        // --- Event Listeners ---

        linearBtn.addEventListener('click', () => {
            gradientType = 'linear-gradient';
            setActiveButton(linearBtn);
            angleControl.style.display = 'block';
            updateGradient();
        });

        radialBtn.addEventListener('click', () => {
            gradientType = 'radial-gradient';
            setActiveButton(radialBtn);
            angleControl.style.display = 'none';
            updateGradient();
        });

        conicBtn.addEventListener('click', () => {
            gradientType = 'conic-gradient';
            setActiveButton(conicBtn);
            angleControl.style.display = 'block';
            updateGradient();
        });

        angleSlider.addEventListener('input', (e) => {
            angle = parseInt(e.target.value);
            angleValue.textContent = `${angle}Â°`;
            angleSlider.setAttribute('aria-valuetext', `${angle} degrees`);
            updateGradient();
        });

        opacitySlider.addEventListener('input', (e) => {
            opacity = parseInt(e.target.value);
            opacityValue.textContent = `${opacity}%`;
            opacitySlider.setAttribute('aria-valuetext', `${opacity} percent`);
            updateGradient();
        });

        addColorBtn.addEventListener('click', addColorStop);
        randomizeBtn.addEventListener('click', generateRandomColors);
        closeMessageBtn.addEventListener('click', () => {
            messageBox.style.cssText = 'opacity: 0; bottom: -999px; pointer-events: none;';
            messageBox.setAttribute('aria-hidden', 'true');
        });
        closeDonationBtn.addEventListener('click', hideDonationPopup); // Listener for the new close button

        copyBtn.addEventListener('click', () => {
            cssOutput.select();
            document.execCommand('copy');
            showMessage('CSS code copied!', 1000);
            
            // Visual feedback for copy
            copyIcon.classList.add('hidden');
            checkIcon.classList.remove('hidden');
            setTimeout(() => {
                copyIcon.classList.remove('hidden');
                checkIcon.classList.add('hidden');
            }, 1000);
        });

        shareBtn.addEventListener('click', () => {
            const shareUrl = generateShareURL();
            navigator.clipboard.writeText(shareUrl)
                .then(() => showMessage('Share URL copied to clipboard! ðŸ“‹', 2000))
                .catch(() => showMessage('Failed to copy URL.', 2000));
        });

        // --- Initialization ---

        const initialize = () => {
            if (!loadFromURL()) {
                // Default gradient if no URL parameter is present
                colors = [
                    { id: nextColorId++, color: '#4f46e5', position: 0 },
                    { id: nextColorId++, color: '#ec4899', position: 100 }
                ];
                colors.forEach(color => colorStopsContainer.appendChild(createColorStopElement(color)));
                updateGradient();
            }

            // Show donation popup after a delay, e.g., 10 seconds, only if not seen this session
            setTimeout(showDonationPopup, 10000); 
        };

        initialize();

    </script>
</body>
</html>

